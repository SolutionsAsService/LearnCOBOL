IDENTIFICATION DIVISION.
PROGRAM-ID. BankTransactionsProcessing.
AUTHOR. Your Name.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT transaction-details ASSIGN TO 'transaction-details.dat'.
    SELECT updated-balances ASSIGN TO 'updated-balances.dat'.

DATA DIVISION.
FILE SECTION.
FD transaction-details.
01 TRANSACTION-RECORD.
    05 ACCOUNT-NUMBER     PIC 9(6).
    05 TRANSACTION-TYPE   PIC X.
        88 DEPOSIT        VALUE 'D'.
        88 WITHDRAWAL     VALUE 'W'.
    05 TRANSACTION-AMOUNT PIC 9(5)V99.

FD updated-balances.
01 UPDATED-BALANCE-RECORD.
    05 UB-ACCOUNT-NUMBER  PIC 9(6).
    05 UB-BALANCE         PIC 9(7)V99.

WORKING-STORAGE SECTION.
01 WS-ACCOUNT-BALANCES.
    05 WS-ACCOUNTS OCCURS 100 TIMES INDEXED BY WS-IDX.
        10 WS-ACC-NUMBER  PIC 9(6).
        10 WS-ACC-BALANCE PIC 9(7)V99.
01 WS-RECORD-COUNT        PIC 9(3) VALUE 0.
01 WS-END-OF-FILE         PIC X VALUE 'N'.
    88 EOF                VALUE 'Y'.
    88 NOT-EOF            VALUE 'N'.

PROCEDURE DIVISION.
BEGIN.
    OPEN INPUT transaction-details
        OUTPUT updated-balances
    PERFORM UNTIL EOF
        READ transaction-details INTO TRANSACTION-RECORD
            AT END
                SET EOF TO TRUE
            NOT AT END
                PERFORM PROCESS-TRANSACTION
        END-READ
    END-PERFORM
    PERFORM WRITE-UPDATED-BALANCES
    CLOSE transaction-details
          updated-balances
    STOP RUN.

PROCESS-TRANSACTION.
    SET WS-IDX TO 1
    SEARCH WS-ACCOUNTS AT END MOVE WS-RECORD-COUNT TO WS-IDX
        WHEN WS-ACC-NUMBER (WS-IDX) = ACCOUNT-NUMBER
            IF DEPOSIT
                ADD TRANSACTION-AMOUNT TO WS-ACC-BALANCE (WS-IDX)
            ELSE
                SUBTRACT TRANSACTION-AMOUNT FROM WS-ACC-BALANCE (WS-IDX)
            END-IF
    END-SEARCH
    IF WS-IDX > WS-RECORD-COUNT
        ADD 1 TO WS-RECORD-COUNT
        MOVE ACCOUNT-NUMBER TO WS-ACC-NUMBER (WS-IDX)
        MOVE TRANSACTION-AMOUNT TO WS-ACC-BALANCE (WS-IDX)
        IF WITHDRAWAL
            COMPUTE WS-ACC-BALANCE (WS-IDX) = 0 - WS-ACC-BALANCE (WS-IDX)
        END-IF
    END-IF.

WRITE-UPDATED-BALANCES.
    PERFORM VARYING WS-IDX FROM 1 BY 1 UNTIL WS-IDX > WS-RECORD-COUNT
        MOVE WS-ACC-NUMBER (WS-IDX) TO UB-ACCOUNT-NUMBER
        MOVE WS-ACC-BALANCE (WS-IDX) TO UB-BALANCE
        WRITE UPDATED-BALANCE-RECORD
    END-PERFORM.
