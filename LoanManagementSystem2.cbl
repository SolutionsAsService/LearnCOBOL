IDENTIFICATION DIVISION.
PROGRAM-ID. LoanManagementSystem.
AUTHOR. Your Name.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT loan-file ASSIGN TO 'loan-file.dat'.
    SELECT payment-file ASSIGN TO 'payment-file.dat'.
    SELECT statement-file ASSIGN TO 'statement-file.dat'.

DATA DIVISION.
FILE SECTION.
FD loan-file.
01 LOAN-RECORD.
    05 LOAN-ID            PIC X(10).
    05 CUSTOMER-ID        PIC X(10).
    05 LOAN-AMOUNT        PIC 9(7)V99.
    05 BALANCE            PIC 9(7)V99.
    05 INTEREST-RATE      PIC V9(3).
    05 LOAN-START-DATE    PIC 9(8).
    05 LOAN-END-DATE      PIC 9(8).
    05 MONTHLY-PAYMENT    PIC 9(5)V99.

FD payment-file.
01 PAYMENT-RECORD.
    05 P-LOAN-ID          PIC X(10).
    05 PAYMENT-DATE       PIC 9(8).
    05 PAYMENT-AMOUNT     PIC 9(5)V99.

FD statement-file.
01 STATEMENT-RECORD.
    05 ST-LOAN-ID         PIC X(10).
    05 ST-CUSTOMER-ID     PIC X(10).
    05 ST-BALANCE         PIC 9(7)V99.
    05 ST-PAYMENT-DUE     PIC 9(5)V99.
    05 ST-DUE-DATE        PIC 9(8).

WORKING-STORAGE SECTION.
01 WS-END-OF-FILE         PIC X VALUE 'N'.
    88 EOF                VALUE 'Y'.
    88 NOT-EOF            VALUE 'N'.

PROCEDURE DIVISION.
BEGIN.
    OPEN INPUT loan-file payment-file
        OUTPUT statement-file
    PERFORM PROCESS-LOANS UNTIL EOF
    CLOSE loan-file payment-file statement-file
    STOP RUN.

PROCESS-LOANS.
    READ loan-file INTO LOAN-RECORD AT END SET EOF TO TRUE.
    PERFORM UNTIL EOF
        PERFORM APPLY-PAYMENTS
        PERFORM UPDATE-BALANCE
        PERFORM GENERATE-STATEMENT
        READ loan-file INTO LOAN-RECORD AT END SET EOF TO TRUE.
    END-PERFORM.

APPLY-PAYMENTS.
    PERFORM UNTIL EOF
        READ payment-file INTO PAYMENT-RECORD AT END SET EOF TO TRUE
        IF P-LOAN-ID = LOAN-ID
            SUBTRACT PAYMENT-AMOUNT FROM BALANCE
        END-IF
    END-PERFORM.

UPDATE-BALANCE.
    COMPUTE BALANCE = BALANCE + (BALANCE * INTEREST-RATE / 12)
    IF BALANCE < 0
        MOVE 0 TO BALANCE
    END-IF
    REWRITE LOAN-RECORD.

GENERATE-STATEMENT.
    MOVE LOAN-ID TO ST-LOAN-ID
    MOVE CUSTOMER-ID TO ST-CUSTOMER-ID
    MOVE BALANCE TO ST-BALANCE
    MOVE MONTHLY-PAYMENT TO ST-PAYMENT-DUE
    COMPUTE ST-DUE-DATE = FUNCTION NUMVAL-C(FUNCTION CURRENT-DATE) + 30
    WRITE STATEMENT-RECORD.
